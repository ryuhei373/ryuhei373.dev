name: Test X Post

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        run: |
          pip install requests requests-oauthlib
          python3 << 'EOF'
          import os
          from requests_oauthlib import OAuth1Session

          client = OAuth1Session(
              os.environ['X_API_KEY'],
              client_secret=os.environ['X_API_SECRET'],
              resource_owner_key=os.environ['X_ACCESS_TOKEN'],
              resource_owner_secret=os.environ['X_ACCESS_TOKEN_SECRET']
          )

          response = client.post(
              "https://api.twitter.com/2/tweets",
              json={"text": "テスト"}
          )

          if response.status_code == 201:
              print("Posted to X successfully")
              print(response.json())
          else:
              print(f"Error: {response.status_code}")
              print(response.text)
              exit(1)
          EOF
