name: Post to Social Media

on:
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'
  pull_request:
    branches:
      - main
    paths:
      - 'content/blog/**'
  workflow_dispatch:
    inputs:
      test_file:
        description: 'ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: content/blog/2026-01-13.mdï¼‰'
        type: string
        default: ''
      test_pr_number:
        description: 'ã‚³ãƒ¡ãƒ³ãƒˆå…ˆã®PRç•ªå·'
        type: string
        default: ''
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„ï¼‰'
        type: boolean
        default: true

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get new blog posts
        id: new-posts
        run: |
          TEST_FILE="${{ inputs.test_file }}"

          if [ -n "$TEST_FILE" ]; then
            # workflow_dispatchã§ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if [ -f "$TEST_FILE" ]; then
              NEW_FILES="$TEST_FILE"
              echo "::notice::Using test file: $TEST_FILE"
            else
              echo "::error::Test file not found: $TEST_FILE"
              echo "has_new_posts=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRã®å ´åˆ: ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            NEW_FILES=$(git diff --no-renames --name-only --diff-filter=A "$BASE_SHA" HEAD -- 'content/blog/*.md')
          else
            # pushã®å ´åˆ: ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®å·®åˆ†
            NEW_FILES=$(git diff --no-renames --name-only --diff-filter=A HEAD~1 HEAD -- 'content/blog/*.md')
          fi

          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found"
            echo "has_new_posts=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_new_posts=true" >> "$GITHUB_OUTPUT"

          # æœ€åˆã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ï¼ˆè¤‡æ•°è¨˜äº‹ã®åŒæ™‚è¿½åŠ ã¯æƒ³å®šå¤–ï¼‰
          FILE=$(echo "$NEW_FILES" | head -n 1)
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

          # frontmatterã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
          TITLE=$(sed -n '/^---$/,/^---$/p' "$FILE" | grep '^title:' | sed 's/^title: *//')
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚¹ãƒ©ãƒƒã‚°ã‚’å–å¾—ï¼ˆä¾‹: 2026-01-12.md -> 2026-01-12ï¼‰
          SLUG=$(basename "$FILE" .md)
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"

          # URLã‚’ç”Ÿæˆ
          URL="https://ryuhei373.dev/blog/$SLUG"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

          echo "::notice::New blog post found: $TITLE ($URL)"

      - name: Get PR number
        if: steps.new-posts.outputs.has_new_posts == 'true'
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEST_PR="${{ inputs.test_pr_number }}"

          if [ -n "$TEST_PR" ]; then
            # workflow_dispatchã§PRç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            PR_NUMBER="$TEST_PR"
            echo "::notice::Using test PR number: $PR_NUMBER"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ: ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰PRç•ªå·ã‚’å–å¾—
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            # pushã®å ´åˆ: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰é–¢é€£ã™ã‚‹PRç•ªå·ã‚’å–å¾—
            PR_NUMBER=$(gh pr list --state merged --search "${{ github.sha }}" --json number --jq '.[0].number')

            if [ -z "$PR_NUMBER" ]; then
              # ç›´æ¥pushã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰PRç•ªå·ã‚’æ¢ã™
              PR_NUMBER=$(git log -1 --pretty=%B | grep -oP '#\K[0-9]+' | head -1)
            fi
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "::notice::PR number: $PR_NUMBER"

      - name: Generate share links
        if: steps.new-posts.outputs.has_new_posts == 'true'
        id: share-links
        run: |
          TITLE="${{ steps.new-posts.outputs.title }}"
          URL="${{ steps.new-posts.outputs.url }}"

          # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆjqã‚’ä½¿ç”¨ï¼‰
          ENCODED_TEXT=$(printf '%s' "$TITLE $URL" | jq -sRr @uri)

          # Intent URLs
          X_INTENT="https://twitter.com/intent/tweet?text=${ENCODED_TEXT}"
          BSKY_INTENT="https://bsky.app/intent/compose?text=${ENCODED_TEXT}"

          echo "x_intent=$X_INTENT" >> "$GITHUB_OUTPUT"
          echo "bsky_intent=$BSKY_INTENT" >> "$GITHUB_OUTPUT"

          # ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆæ¤œè¨¼ç”¨ï¼‰
          echo "::group::Share Links"
          echo "X (Twitter): $X_INTENT"
          echo "Bluesky: $BSKY_INTENT"
          echo "::endgroup::"

      - name: Comment on PR with share links
        if: |
          steps.new-posts.outputs.has_new_posts == 'true' &&
          steps.get-pr.outputs.pr_number != '' &&
          (github.event_name != 'workflow_dispatch' || inputs.dry_run == false)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="${{ steps.new-posts.outputs.title }}"
          URL="${{ steps.new-posts.outputs.url }}"
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"
          X_INTENT="${{ steps.share-links.outputs.x_intent }}"
          BSKY_INTENT="${{ steps.share-links.outputs.bsky_intent }}"

          BODY=$(printf '%s\n' \
            "## ğŸ“¢ SNSã§ã‚·ã‚§ã‚¢" \
            "" \
            "æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼" \
            "" \
            "**${TITLE}**" \
            "${URL}" \
            "" \
            "ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰SNSã«æŠ•ç¨¿ã§ãã¾ã™ï¼š" \
            "" \
            "- [X (Twitter) ã§ãƒã‚¹ãƒˆ](${X_INTENT})" \
            "- [Bluesky ã§ãƒã‚¹ãƒˆ](${BSKY_INTENT})")

          gh pr comment "$PR_NUMBER" --body "$BODY"
          echo "::notice::Comment posted to PR #$PR_NUMBER"

      - name: Dry run summary
        if: |
          steps.new-posts.outputs.has_new_posts == 'true' &&
          (github.event_name == 'workflow_dispatch' && inputs.dry_run == true)
        run: |
          echo "::warning::Dry run mode - no comment posted"
          echo "Would comment on PR #${{ steps.get-pr.outputs.pr_number }}"
