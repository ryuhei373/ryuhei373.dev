name: Post to Social Media

on:
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get new blog posts
        id: new-posts
        run: |
          # Êñ∞Ë¶èËøΩÂä†„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂèñÂæó
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'content/blog/*.md')

          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_new_posts=true" >> $GITHUB_OUTPUT

          # ÊúÄÂàù„ÅÆÊñ∞Ë¶è„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜÔºàË§áÊï∞Ë®ò‰∫ã„ÅÆÂêåÊôÇËøΩÂä†„ÅØÊÉ≥ÂÆöÂ§ñÔºâ
          FILE=$(echo "$NEW_FILES" | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

          # frontmatter„Åã„Çâ„Çø„Ç§„Éà„É´„ÇíÂèñÂæó
          TITLE=$(sed -n '/^---$/,/^---$/p' "$FILE" | grep '^title:' | sed 's/^title: *//')
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # „Éï„Ç°„Ç§„É´Âêç„Åã„Çâ„Çπ„É©„ÉÉ„Ç∞„ÇíÂèñÂæóÔºà‰æã: 2026-01-12.md -> 2026-01-12Ôºâ
          SLUG=$(basename "$FILE" .md)
          echo "slug=$SLUG" >> $GITHUB_OUTPUT

          # URL„ÇíÁîüÊàê
          URL="https://ryuhei373.dev/blog/$SLUG"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Get merged PR number
        if: steps.new-posts.outputs.has_new_posts == 'true'
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # „Éû„Éº„Ç∏„Ç≥„Éü„ÉÉ„Éà„Åã„ÇâÈñ¢ÈÄ£„Åô„ÇãPRÁï™Âè∑„ÇíÂèñÂæó
          PR_NUMBER=$(gh pr list --state merged --search "${{ github.sha }}" --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            # Áõ¥Êé•push„ÅÆÂ†¥Âêà„ÅØ„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâPRÁï™Âè∑„ÇíÊé¢„Åô
            PR_NUMBER=$(git log -1 --pretty=%B | grep -oP '#\K[0-9]+' | head -1)
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Comment on PR with share links
        if: steps.new-posts.outputs.has_new_posts == 'true' && steps.get-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="${{ steps.new-posts.outputs.title }}"
          URL="${{ steps.new-posts.outputs.url }}"
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          # URL„Ç®„É≥„Ç≥„Éº„ÉâÔºàjq„Çí‰ΩøÁî®Ôºâ
          ENCODED_TEXT=$(printf '%s' "$TITLE $URL" | jq -sRr @uri)

          # Intent URLs
          X_INTENT="https://twitter.com/intent/tweet?text=${ENCODED_TEXT}"
          BSKY_INTENT="https://bsky.app/intent/compose?text=${ENCODED_TEXT}"

          # PR„Å´„Ç≥„É°„É≥„Éà
          gh pr comment "$PR_NUMBER" --body "$(cat <<EOF
## üì¢ SNS„Åß„Ç∑„Çß„Ç¢

Êñ∞„Åó„ÅÑ„Éñ„É≠„Ç∞Ë®ò‰∫ã„ÅåÂÖ¨Èñã„Åï„Çå„Åæ„Åó„ÅüÔºÅ

**${TITLE}**
${URL}

‰ª•‰∏ã„ÅÆ„É™„É≥„ÇØ„Åã„ÇâSNS„Å´ÊäïÁ®ø„Åß„Åç„Åæ„ÅôÔºö

- [X (Twitter) „Åß„Éù„Çπ„Éà](${X_INTENT})
- [Bluesky „Åß„Éù„Çπ„Éà](${BSKY_INTENT})
EOF
          )"
