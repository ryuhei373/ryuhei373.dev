name: Post to Social Media

on:
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get new blog posts
        id: new-posts
        run: |
          # æ–°è¦è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å–å¾—ï¼ˆ--no-renamesã§ãƒªãƒãƒ¼ãƒ æ¤œå‡ºã‚’ç„¡åŠ¹åŒ–ï¼‰
          NEW_FILES=$(git diff --no-renames --name-only --diff-filter=A HEAD~1 HEAD -- 'content/blog/*.md')

          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found"
            echo "has_new_posts=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_new_posts=true" >> "$GITHUB_OUTPUT"

          # æœ€åˆã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ï¼ˆè¤‡æ•°è¨˜äº‹ã®åŒæ™‚è¿½åŠ ã¯æƒ³å®šå¤–ï¼‰
          FILE=$(echo "$NEW_FILES" | head -n 1)
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

          # frontmatterã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
          TITLE=$(sed -n '/^---$/,/^---$/p' "$FILE" | grep '^title:' | sed 's/^title: *//')
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚¹ãƒ©ãƒƒã‚°ã‚’å–å¾—ï¼ˆä¾‹: 2026-01-12.md -> 2026-01-12ï¼‰
          SLUG=$(basename "$FILE" .md)
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"

          # URLã‚’ç”Ÿæˆ
          URL="https://ryuhei373.dev/blog/$SLUG"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Get merged PR number
        if: steps.new-posts.outputs.has_new_posts == 'true'
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰é–¢é€£ã™ã‚‹PRç•ªå·ã‚’å–å¾—
          PR_NUMBER=$(gh pr list --state merged --search "${{ github.sha }}" --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            # ç›´æ¥pushã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰PRç•ªå·ã‚’æ¢ã™
            PR_NUMBER=$(git log -1 --pretty=%B | grep -oP '#\K[0-9]+' | head -1)
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Comment on PR with share links
        if: steps.new-posts.outputs.has_new_posts == 'true' && steps.get-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="${{ steps.new-posts.outputs.title }}"
          URL="${{ steps.new-posts.outputs.url }}"
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆjqã‚’ä½¿ç”¨ï¼‰
          ENCODED_TEXT=$(printf '%s' "$TITLE $URL" | jq -sRr @uri)

          # Intent URLs
          X_INTENT="https://twitter.com/intent/tweet?text=${ENCODED_TEXT}"
          BSKY_INTENT="https://bsky.app/intent/compose?text=${ENCODED_TEXT}"

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          BODY=$(printf '%s\n' \
            "## ğŸ“¢ SNSã§ã‚·ã‚§ã‚¢" \
            "" \
            "æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼" \
            "" \
            "**${TITLE}**" \
            "${URL}" \
            "" \
            "ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰SNSã«æŠ•ç¨¿ã§ãã¾ã™ï¼š" \
            "" \
            "- [X (Twitter) ã§ãƒã‚¹ãƒˆ](${X_INTENT})" \
            "- [Bluesky ã§ãƒã‚¹ãƒˆ](${BSKY_INTENT})")
          gh pr comment "$PR_NUMBER" --body "$BODY"
